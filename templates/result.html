<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Alarms Dashboard</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- DataTables -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css"
    />
    <!-- FontAwesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background-color: #f4f6f9;
        font-size: 14px;
      }

      body.dark-mode {
        background-color: #121212;
        color: #eaeaea;
      }

      body.dark-mode .card,
      body.dark-mode .office-card {
        background-color: #1e1e1e;
        color: #eaeaea;
      }

      .kpi-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 18px;
        border-radius: 14px;
        color: #fff;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transition: 0.3s ease;
      }

      .kpi-card:hover {
        transform: translateY(-4px);
      }

      .kpi-title {
        font-size: 14px;
        opacity: 0.9;
      }

      .kpi-value {
        font-size: 32px;
        font-weight: bold;
      }

      .kpi-icon i {
        font-size: 36px;
        opacity: 0.8;
      }

      .kpi-danger {
        background: linear-gradient(135deg, #ff4b2b, #ff416c);
      }

      .kpi-warning {
        background: linear-gradient(135deg, #f7971e, #ffd200);
        color: #000;
      }

      .kpi-info {
        background: linear-gradient(135deg, #36d1dc, #5b86e5);
      }

      .office-card {
        background: #fff;
        border-radius: 12px;
        padding: 14px;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
        border-left: 5px solid #0d6efd;
      }

      table {
        width: 100% !important;
      }

      #downTable th,
      #envTable th,
      #criticalEnvTable th {
        background-color: #212529;
        color: #fff;
        text-align: center;
        font-size: 13px;
      }

      td {
        font-size: 13px;
      }

      td.site-name,
      th.site-name {
        max-width: 100px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: bold;
      }

      @media (max-width: 768px) {
        .kpi-value {
          font-size: 24px;
        }
        .kpi-card {
          padding: 12px;
        }
        #downTable th,
        #envTable th,
        #criticalEnvTable th,
        td {
          font-size: 11px;
        }
        .btn {
          padding: 5px 10px;
          font-size: 12px;
        }
        h3 {
          font-size: 1.25rem;
        }
      }

      td.comment select {
        width: 100%;
        min-width: 150px;
        white-space: normal;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      td.comment select option {
        white-space: nowrap;
      }

      body.dark-mode #downTable td,
      body.dark-mode #envTable td {
        background-color: #1e1e1e;
        color: #eaeaea;
      }

      .badge {
        font-size: 9px;
        border-radius: 10px;
        padding: 5px 8px;
        margin-top: 5px;
      }

      .badge-vip {
        background: #dc9135;
      }

      .badge-ceo {
        background: #8ec142;
      }

      .badge-router {
        background: #0dcaf0;
        color: #000;
      }

      .badge-bdt {
        background: #2427cc;
      }

      .badge-nodal {
        background: #fd3b14;
      }

      .badge-power {
        background: #ebe831;
        color: #000;
      }

      .badge-site {
        background: #415d5e;
      }
      .bold-text {
        font-weight: bold !important;
        font-size: 14px; /* Slightly larger for emphasis */
      }
      .long-duration-row td {
        background-color: #fcebeb !important; /* Slightly more reddish */
      }
      body.dark-mode .long-duration-row td {
        background-color: #4a3535 !important;
      }
      .cleared-row td {
        background-color: #dbf5db !important; /* Lite Green */
      }
      body.dark-mode .cleared-row td {
        background-color: #1b3320 !important;
      }
      .in-progress-row td {
        background-color: #fffee0 !important; /* Yellowish Grey */
      }
      body.dark-mode .in-progress-row td {
        background-color: #3b3b28 !important;
      }
      .filter-card {
        background: #ffffff;
        border-radius: 12px;
        border: none;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        margin-bottom: 25px;
      }
      body.dark-mode .filter-card {
        background: #1e1e1e;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }
      .filter-label {
        font-weight: 600;
        font-size: 13px;
        color: #495057;
        margin-bottom: 6px;
      }
      body.dark-mode .filter-label {
        color: #adb5bd;
      }
      .filter-input {
        border-radius: 8px;
        border: 1px solid #dee2e6;
        padding: 8px 12px;
        font-size: 13px;
        transition: all 0.2s;
      }
      body.dark-mode .filter-input {
        background-color: #2b2b2b;
        border-color: #444;
        color: #eaeaea;
      }
      .filter-input:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.1);
      }
    </style>
  </head>

  <body>
    <div class="container-fluid p-4">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>
          <i class="fas fa-network-wired"></i> Last 40 Days Alarms Dashboard
        </h3>

        <div>
          <button id="toggleDark" class="btn btn-outline-secondary me-2">
            <i id="themeIcon" class="fas fa-moon"></i>
          </button>
          <a
            href="/download?file={{ excel_path }}"
            class="btn btn-success me-2"
          >
            <i class="fas fa-file-excel"></i> Download Excel
          </a>
          <button id="copyImage" class="btn btn-primary me-2">
            <i class="fas fa-camera"></i> Copy Table as Image
          </button>
          <button id="shareWhatsApp" class="btn btn-success me-2">
            <i class="fab fa-whatsapp"></i> Share to WhatsApp
          </button>
          <a href="/" class="btn btn-secondary">
            <i class="fas fa-undo"></i> Start Over
          </a>
        </div>
      </div>

      <!-- KPI Cards -->
      <div class="row g-3 mb-4">
        <div class="col-xl-4 col-md-6">
          <div class="kpi-card kpi-danger">
            <div>
              <div class="kpi-title">Total Down Sites</div>
              <div class="kpi-value">
                {{ dashboard_summary.get('Total Down Sites',0) }}
              </div>
            </div>
            <div class="kpi-icon"><i class="fas fa-broadcast-tower"></i></div>
          </div>
        </div>
        <div class="col-xl-4 col-md-6">
          <div class="kpi-card kpi-warning">
            <div>
              <div class="kpi-title">Partial Down Sites</div>
              <div class="kpi-value">
                {{ dashboard_summary.get('Total Partial Sites',0) }}
              </div>
            </div>
            <div class="kpi-icon">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
          </div>
        </div>
        <div class="col-xl-4 col-md-6">
          <div class="kpi-card kpi-info">
            <div>
              <div class="kpi-title">Total ENV Alarms</div>
              <div class="kpi-value">
                {{ dashboard_summary.get('Total Env Alarms',0) }}
              </div>
            </div>
            <div class="kpi-icon"><i class="fas fa-fan"></i></div>
          </div>
        </div>
      </div>
      <!-- SC Offices -->
      <h5 class="mb-3">SC Offices Overview</h5>
      <div class="row g-3 mb-4">
        {% for office, stats in dashboard.items() %}
        <div class="col-xl-3 col-md-4 col-sm-6">
          <div class="office-card">
            <h6>{{ office }}</h6>
            <div class="text-danger">ðŸ”´ Total: {{ stats['Total Down'] }}</div>
            <div class="text-warning">
              ðŸŸ¡ Partial: {{ stats['Partial Down'] }}
            </div>
            <div class="text-info">ðŸŒ¬ ENV: {{ stats['ENV'] }}</div>
          </div>
        </div>
        {% endfor %}
      </div>
      <!-- Slicers / Filters -->
      <div class="card filter-card">
        <div class="card-body p-4">
          <div class="d-flex align-items-center mb-3">
            <i class="fas fa-filter text-primary me-2"></i>
            <h6 class="mb-0 fw-bold">Live Filtering Console</h6>
          </div>
          <div class="row g-3">
            <div class="col-lg-3 col-md-6">
              <label for="officeFilter" class="filter-label">SC Office</label>
              <select
                id="officeFilter"
                class="form-select filter-input"
                multiple
              >
                {% for office in dashboard.keys() %}
                <option value="{{ office }}">{{ office }}</option>
                {% endfor %}
              </select>
              <div class="mt-1">
                <small class="text-muted" style="font-size: 10px"
                  >Ctrl/Cmd + Click for multiple</small
                >
              </div>
            </div>
            <div class="col-lg-3 col-md-6">
              <label for="startDateFilter" class="filter-label"
                >Start Date</label
              >
              <input
                type="date"
                id="startDateFilter"
                class="form-control filter-input"
              />
            </div>
            <div class="col-lg-3 col-md-6">
              <label for="endDateFilter" class="filter-label">End Date</label>
              <input
                type="date"
                id="endDateFilter"
                class="form-control filter-input"
              />
            </div>
            <div class="col-lg-3 col-md-6 d-flex align-items-end">
              <button
                id="clearFilters"
                class="btn btn-outline-danger w-100 py-2"
              >
                <i class="fas fa-sync-alt me-1"></i> Reset All Filters
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
          <button
            class="nav-link active"
            data-bs-toggle="tab"
            data-bs-target="#downTab"
          >
            Down Alarms
          </button>
        </li>
        <li class="nav-item">
          <button
            class="nav-link"
            data-bs-toggle="tab"
            data-bs-target="#envTab"
          >
            ENV Alarms
          </button>
        </li>
        <li class="nav-item">
          <button
            class="nav-link"
            data-bs-toggle="tab"
            data-bs-target="#criticalEnvTab"
          >
            Critical ENV Alarms
          </button>
        </li>
      </ul>

      <div class="tab-content">
        <!-- DOWN TAB -->
        <div class="tab-pane fade show active" id="downTab">
          {% if tables_down_env|length > 0 %}
          <div class="row mb-2">
            <div class="col-md-4">
              <input
                type="text"
                id="downSearch"
                class="form-control form-control-sm"
                placeholder="Search Down Alarms..."
              />
            </div>
          </div>
          <div class="table-responsive">
            <table id="downTable" class="table table-striped table-bordered">
              <thead>
                <tr>
                  {% for key in tables_down_env[0].keys() %} {% if not
                  key.startswith("_") %}
                  <th
                    class="{% if key=='Comment' %}comment{% endif %} {% if key in ['Site Code','Site Name', 'Down Alarm', 'Down Alarm Description', 'ENV Alarms', 'ENV Alarm'] %}bold-text{% endif %}"
                  >
                    {{ key }}
                  </th>
                  {% endif %} {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for row in tables_down_env %}
                <tr
                  class="{% if row.get('_long_duration') %}long-duration-row{% endif %}"
                >
                  {% for key,val in row.items() %} {% if not key.startswith("_")
                  %}
                  <td
                    class="{% if key=='Comment' %}comment{% endif %} {% if key in ['Site Code','Site Name', 'Down Alarm', 'Down Alarm Description', 'ENV Alarms', 'ENV Alarm'] %}bold-text{% endif %}"
                  >
                    {% if key=="Comment" %}
                    <select
                      class="form-select form-select-sm comment-persist"
                      data-sitecode="{{ row['Site Code'] }}"
                      title="{{ val|join(', ') }}"
                    >
                      {% for option in val %}
                      <option>{{ option|e }}</option>
                      {% endfor %}
                    </select>
                    {% else %} {{ val|safe }} {% endif %}
                  </td>
                  {% endif %} {% endfor %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="alert alert-info">No Down Alarms Available</div>
          {% endif %}
        </div>

        <!-- ENV TAB -->
        <div class="tab-pane fade" id="envTab">
          {% if tables_env_only|length > 0 %}
          <div class="row mb-2">
            <div class="col-md-4">
              <input
                type="text"
                id="envSearch"
                class="form-control form-control-sm"
                placeholder="Search ENV Alarms..."
              />
            </div>
          </div>
          <div class="table-responsive">
            <table id="envTable" class="table table-striped table-bordered">
              <thead>
                <tr>
                  {% for key in tables_env_only[0].keys() %} {% if not
                  key.startswith("_") and key != "Comment" %}
                  <th
                    class="{% if key in ['Site Code','Site Name', 'Down Alarm', 'Down Alarm Description', 'ENV Alarms', 'ENV Alarm'] %}bold-text{% endif %}"
                  >
                    {{ key }}
                  </th>
                  {% endif %} {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for row in tables_env_only %}
                <tr
                  class="{% if row.get('_long_duration') %}long-duration-row{% endif %}"
                >
                  {% for key,val in row.items() %} {% if not key.startswith("_")
                  and key != "Comment" %}
                  <td
                    class="{% if key in ['Site Code','Site Name', 'Down Alarm', 'Down Alarm Description', 'ENV Alarms', 'ENV Alarm'] %}bold-text{% endif %}"
                  >
                    {{ val|safe }}
                  </td>
                  {% endif %} {% endfor %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="alert alert-info">No ENV Alarms Available</div>
          {% endif %}
        </div>

        <!-- CRITICAL ENV TAB -->
        <div class="tab-pane fade" id="criticalEnvTab">
          {% if critical_env_table|length > 0 %}
          <div class="row mb-2">
            <div class="col-md-4">
              <input
                type="text"
                id="criticalEnvSearch"
                class="form-control form-control-sm"
                placeholder="Search Critical ENV..."
              />
            </div>
          </div>
          <div class="table-responsive">
            <table
              id="criticalEnvTable"
              class="table table-striped table-bordered"
            >
              <thead>
                <tr>
                  {% for key in critical_env_table[0].keys() %} {% if not
                  key.startswith("_") %}
                  <th
                    class="{% if key in ['Site Code','Site Name', 'ENV Alarm'] %}bold-text{% endif %}"
                  >
                    {{ key }}
                  </th>
                  {% endif %} {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for row in critical_env_table %}
                <tr
                  class="{% if row.get('_long_duration') %}long-duration-row{% endif %}"
                >
                  {% for key,val in row.items() %} {% if not key.startswith("_")
                  %}
                  <td
                    class="{% if key in ['Site Code','Site Name', 'ENV Alarm'] %}bold-text{% endif %}"
                  >
                    {{ val|safe }}
                  </td>
                  {% endif %} {% endfor %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="alert alert-info">No Critical ENV Alarms Available</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
      $(document).ready(function () {
        // DOWN TABLE
        if ($("#downTable").length) {
          var downTable = $("#downTable").DataTable({
            pageLength: 25,
            ordering: false,
            lengthChange: false,
            autoWidth: false,
            columnDefs: [
              { targets: [6], visible: false },
              { targets: [1], maxWidth: 80 },
            ],
            dom: "Bfrtip",
            buttons: ["excel", "csv", "print"],
          });
          $("#downSearch").on("keyup", function () {
            downTable.search(this.value).draw();
          });
        }

        // ENV TABLE
        if ($("#envTable").length) {
          var envTable = $("#envTable").DataTable({
            pageLength: 25,
            ordering: false,
            lengthChange: false,
            autoWidth: false,
            columnDefs: [{ targets: [3, 4, 5, 6], visible: false }],
            dom: "Bfrtip",
            buttons: ["excel", "csv", "print"],
          });
          $("#envSearch").on("keyup", function () {
            envTable.search(this.value).draw();
          });

          var envColIndex = 7;
          var uniqueValues = [];
          envTable
            .column(envColIndex)
            .data()
            .each(function (value) {
              if (value)
                value.split(" | ").forEach((v) => {
                  if (!uniqueValues.includes(v)) uniqueValues.push(v);
                });
            });
          uniqueValues
            .sort()
            .forEach((v) =>
              $("#envAlarmFilter").append(
                '<option value="' + v + '">' + v + "</option>",
              ),
            );
          var defaultSelected = [
            "Power",
            "High temp",
            "Fire",
            "Air Condition",
            "Major",
          ];
          $("#envAlarmFilter").val(defaultSelected);

          $.fn.dataTable.ext.search.push(function (settings, data) {
            if (settings.nTable.id !== "envTable") return true;
            var selected = $("#envAlarmFilter").val();
            if (!selected || selected.length === 0) return true;
            var envText = data[envColIndex];
            return selected.some((val) => envText.includes(val));
          });

          $("#envAlarmFilter").on("change", function () {
            envTable.draw();
          });
        }

        // --- Persistent Comments Logic ---
        function updateRowHighlight($el) {
          const val = $el.val();
          const tr = $el.closest("tr");
          tr.removeClass("cleared-row in-progress-row");

          if (val === "Cleared" || val === "Clear") {
            tr.addClass("cleared-row");
          } else if (
            [
              "About to Reach",
              "Access Requested",
              "Calling Soc team",
              "waiting Access",
              "Working in site",
            ].includes(val)
          ) {
            tr.addClass("in-progress-row");
          }
        }

        function loadSavedComments() {
          $(".comment-persist").each(function () {
            const siteCode = $(this).data("sitecode");
            const savedValue = localStorage.getItem("comment_" + siteCode);
            if (savedValue) {
              $(this).val(savedValue);
            }
            updateRowHighlight($(this));
          });
        }

        $(document).on("change", ".comment-persist", function () {
          const siteCode = $(this).data("sitecode");
          const val = $(this).val();
          if (siteCode) {
            localStorage.setItem("comment_" + siteCode, val);
          }
          updateRowHighlight($(this));
        });

        // Initialize saved comments
        loadSavedComments();

        // Re-apply comments when tables are redrawn (pagination, sorting, filtering)
        if (typeof downTable !== "undefined")
          downTable.on("draw", loadSavedComments);
        if (typeof envTable !== "undefined")
          envTable.on("draw", loadSavedComments);

        // Dark Mode
        const toggleBtn = document.getElementById("toggleDark");
        const body = document.body;
        const icon = document.getElementById("themeIcon");
        function updateIcon() {
          icon.className = body.classList.contains("dark-mode")
            ? "fas fa-sun"
            : "fas fa-moon";
        }
        if (localStorage.getItem("darkMode") === "enabled")
          body.classList.add("dark-mode");
        updateIcon();
        toggleBtn.addEventListener("click", () => {
          body.classList.toggle("dark-mode");
          localStorage.setItem(
            "darkMode",
            body.classList.contains("dark-mode") ? "enabled" : "disabled",
          );
          updateIcon();
        });

        // Copy table as image with high quality
        $("#copyImage").click(function () {
          const activeTabId = $(".tab-pane.active").attr("id");
          const target = document.querySelector("#" + activeTabId + " table");

          if (!target) return;

          // Show a feedback to the user
          const btn = $(this);
          const originalHtml = btn.html();
          btn.html('<i class="fas fa-spinner fa-spin"></i> Processing...');
          btn.prop("disabled", true);

          html2canvas(target, {
            scale: 4, // Ultra-high definition
            useCORS: true,
            logging: false,
            backgroundColor: body.classList.contains("dark-mode")
              ? "#1e1e1e"
              : "#ffffff",
            windowWidth: 1600, // Force a desktop-width layout for the capture
          }).then((canvas) => {
            canvas.toBlob(
              function (blob) {
                navigator.clipboard
                  .write([new ClipboardItem({ "image/png": blob })])
                  .then(() => {
                    btn.html(originalHtml);
                    btn.prop("disabled", false);
                    alert("Table copied as high-quality image!");
                  })
                  .catch((err) => {
                    btn.html(originalHtml);
                    btn.prop("disabled", false);
                    alert("Failed to copy image to clipboard.");
                  });
              },
              "image/png",
              1.0,
            );
          });
        });

        // WhatsApp Share Functionality
        $("#shareWhatsApp").click(function () {
          const activeTabId = $(".tab-pane.active").attr("id");
          const target = document.querySelector("#" + activeTabId + " table");

          if (!target) return;

          const btn = $(this);
          const originalHtml = btn.html();

          btn.html('<i class="fas fa-spinner fa-spin"></i> Preparing...');
          btn.prop("disabled", true);

          html2canvas(target, {
            scale: 4, // Ultra-high definition
            useCORS: true,
            backgroundColor: body.classList.contains("dark-mode")
              ? "#1e1e1e"
              : "#ffffff",
            windowWidth: 1600, // Ensure wide layout for WhatsApp share too
          }).then((canvas) => {
            canvas.toBlob(
              async (blob) => {
                const file = new File([blob], "Alarms_Report.png", {
                  type: "image/png",
                });
                const shareData = {
                  files: [file],
                  title: "Alarms Report",
                  text: "Detailed Table Record Report",
                };

                // Try using Web Share API (Mobile & some Desktop Browsers)
                if (navigator.canShare && navigator.canShare(shareData)) {
                  try {
                    await navigator.share(shareData);
                    btn.html(originalHtml);
                    btn.prop("disabled", false);
                  } catch (err) {
                    console.error("Share failed:", err);
                    btn.html(originalHtml);
                    btn.prop("disabled", false);
                  }
                } else {
                  // Fallback: Copy to clipboard and open WhatsApp
                  try {
                    await navigator.clipboard.write([
                      new ClipboardItem({ "image/png": blob }),
                    ]);
                    btn.html(originalHtml);
                    btn.prop("disabled", false);

                    if (
                      confirm(
                        "Table image copied to clipboard! Click OK to open WhatsApp and paste (Ctrl+V) it to the group.",
                      )
                    ) {
                      window.open(
                        "https://chat.whatsapp.com/ESrb8mvVRXg5CGPgMI6eVo",
                        "_blank",
                      );
                    }
                  } catch (err) {
                    alert(
                      "Sharing failed. Please use 'Copy Table as Image' then paste manually.",
                    );
                    btn.html(originalHtml);
                    btn.prop("disabled", false);
                  }
                }
              },
              "image/png",
              1.0,
            );
          });
        });

        // Unified Filter Logic (Robust Dynamic Column Detection)
        $.fn.dataTable.ext.search.push(function (settings, data) {
          // 1. SC Office Filter
          var selectedOffices = $("#officeFilter").val();
          var officeInRow = (data[2] || "").trim();
          var officePass = true;
          if (selectedOffices && selectedOffices.length > 0) {
            officePass = selectedOffices.includes(officeInRow);
          }

          // 2. Date Range Filter
          var startInput = $("#startDateFilter").val();
          var endInput = $("#endDateFilter").val();

          // If no date filters are set, we only care about officePass
          if (!startInput && !endInput) return officePass;

          // Find time column index dynamically for this specific table (cached in settings)
          if (typeof settings.timeColIdx === "undefined") {
            var idx = -1;
            // For downTable prioritize "Alarm Time", for others use "ENV Alarm Time"
            var targetTitle =
              settings.nTable.id === "downTable"
                ? "Alarm Time"
                : "ENV Alarm Time";

            settings.aoColumns.forEach(function (col, i) {
              var title = (col.sTitle || "").trim();
              if (title === targetTitle) {
                idx = i;
              }
            });
            settings.timeColIdx = idx;
          }

          var timeColIdx = settings.timeColIdx;
          if (timeColIdx === -1) return officePass; // Table has no time column

          var timeInRowRaw = (data[timeColIdx] || "").trim();
          var datePass = true;

          if (timeInRowRaw) {
            var dateMatch = timeInRowRaw.match(/(\d{4}-\d{2}-\d{2})/);
            if (dateMatch) {
              var dateInRow = dateMatch[1];
              if (startInput && dateInRow < startInput) datePass = false;
              if (endInput && dateInRow > endInput) datePass = false;
            }
          } else {
            // Sites with no time data are hidden if a date filter is active
            datePass = false;
          }

          return officePass && datePass;
        });

        // Event listeners for Filters
        $("#officeFilter, #startDateFilter, #endDateFilter").on(
          "change",
          function () {
            if (typeof downTable !== "undefined") downTable.draw();
            if (typeof envTable !== "undefined") envTable.draw();
            if (typeof criticalEnvTable !== "undefined")
              criticalEnvTable.draw();
          },
        );

        $("#clearFilters").click(function () {
          $("#officeFilter").val([]).trigger("change");
          $("#startDateFilter").val("");
          $("#endDateFilter").val("").trigger("change");
          alert("All filters cleared!");
        });

        // CRITICAL ENV TABLE
        if ($("#criticalEnvTable").length) {
          var criticalEnvTable = $("#criticalEnvTable").DataTable({
            pageLength: 25,
            ordering: true,
            order: [[4, "desc"]],
            lengthChange: false,
            autoWidth: false,
            columnDefs: [{ targets: [1], maxWidth: 80 }],
            dom: "Bfrtip",
            buttons: ["excel", "csv", "print"],
          });
          $("#criticalEnvSearch").on("keyup", function () {
            criticalEnvTable.search(this.value).draw();
          });
        }
      });
    </script>
  </body>
</html>
